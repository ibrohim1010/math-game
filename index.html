<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matematik O'yin ‚Äî Advanced Combo</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        *{box-sizing:border-box}
        html,body{height:100%}
        body{
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            min-height:100vh;display:flex;align-items:flex-start;justify-content:center;padding:18px;color:#fff;
        }
        .container{width:100%;max-width:540px}
        .header{text-align:center;margin:6px 0 18px;}
        .header h1{font-size:1.9rem;margin-bottom:6px;text-shadow:2px 2px 8px rgba(0,0,0,.25);}
        .menu-stats{display:flex;gap:12px;justify-content:center;margin-bottom:18px}
        .stat-card{background:linear-gradient(135deg,#173a6b,#244e8f);padding:10px 14px;border-radius:14px;box-shadow:0 8px 20px rgba(0,0,0,.2);display:flex;align-items:center;gap:10px;min-width:120px}
        .stat-icon{font-size:1.4rem;margin-right:6px}
        .stat-num{font-weight:800;font-size:1.3rem}
        .stat-label{font-size:.8rem;opacity:.95}
        .game-modes{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:18px}
        .mode-btn{padding:22px 14px;border-radius:14px;color:#fff;font-weight:700;border:none;cursor:pointer;position:relative;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,.18);display:flex;flex-direction:column;align-items:center}
        .mode-btn .mode-icon{font-size:2.4rem;margin-bottom:6px}
        .mode-subtitle{font-size:.85rem;margin-top:6px;opacity:.95;text-align:center}
        .multiplier-badge{margin-top:8px;background:rgba(255,255,255,.18);padding:6px 10px;border-radius:12px;font-weight:800}
        .mode-btn.standard{background:linear-gradient(135deg,#11998e,#38ef7d);}
        .mode-btn.premium{background:linear-gradient(135deg,#f093fb,#f5576c);}
        .game-screen{display:none}
        .timer{background:linear-gradient(135deg,#173a6b,#244e8f);padding:14px;border-radius:14px;text-align:center;font-weight:800;font-size:1.6rem;margin-bottom:12px;box-shadow:0 8px 20px rgba(0,0,0,.2);display:flex;justify-content:center;align-items:center;gap:8px}
        .timer::after{content:'s';font-size:.7rem;margin-left:4px}
        .timer.warning{background:linear-gradient(135deg,#f5af19,#f12711)}
        .timer.critical{background:linear-gradient(135deg,#eb3349,#f45c43)}
        .game-stats{display:flex;justify-content:space-between;background:linear-gradient(135deg,#173a6b,#244e8f);padding:10px;border-radius:12px;margin-bottom:14px;box-shadow:0 8px 20px rgba(0,0,0,.15)}
        .game-stats .item{text-align:center}
        .game-stats .value{font-weight:800;font-size:1.1rem}
        .game-stats .label{font-size:.85rem;opacity:.95}
        .question-card{background:#fff;color:#333;padding:28px;border-radius:18px;text-align:center;margin-bottom:14px;box-shadow:0 6px 24px rgba(0,0,0,.12)}
        .question{font-size:2.4rem;font-weight:800;color:#4c6ef5;margin-bottom:18px}
        .answers{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        .answer-btn{background:linear-gradient(135deg,#6a11cb,#2575fc);border:none;padding:14px;border-radius:12px;color:#fff;font-size:1.05rem;font-weight:800;cursor:pointer;box-shadow:0 6px 16px rgba(0,0,0,.15);transition:transform .18s ease,box-shadow .18s ease}
        .answer-btn:active{transform:scale(.98)}
        .answer-btn.correct{background:linear-gradient(135deg,#11998e,#38ef7d);animation:pop .35s;box-shadow:0 10px 30px rgba(0,0,0,.2)}
        .answer-btn.wrong{background:linear-gradient(135deg,#eb3349,#f45c43);animation:shake .45s;box-shadow:0 10px 30px rgba(0,0,0,.18)}
        .score-burst{position:fixed;right:18px;top:18px;font-weight:900;color:#fff;padding:8px 10px;border-radius:8px;background:rgba(0,0,0,.25);pointer-events:none;transform:translateY(-6px);opacity:0;transition:all .5s}
        .score-burst.show{transform:translateY(0);opacity:1}
        .result-screen{display:none}
        .result-card{background:#fff;color:#333;padding:20px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.18);margin-bottom:12px}
        .result-score{font-size:3.2rem;font-weight:900;color:#4c6ef5;margin:8px 0}
        .result-details{display:flex;justify-content:space-around;gap:6px;padding-top:12px;border-top:1px solid #eee}
        .result-detail-item{text-align:center}
        .result-detail-item .icon{font-size:1.6rem}
        .result-detail-item .value{font-weight:800;font-size:1.2rem;color:#4c6ef5}
        .result-detail-item .label{font-size:.85rem;color:#666;margin-top:6px}
        .accuracy-bar{width:100%;height:10px;background:#eee;border-radius:999px;overflow:hidden;margin-top:8px}
        .accuracy-bar > .fill{height:100%;width:0%;background:linear-gradient(90deg,#4c6ef5,#7c5cff)}
        .controls{display:flex;justify-content:center;margin-top:10px;gap:12px}
        .back-btn{background:linear-gradient(135deg,#667eea,#764ba2);border:none;padding:10px 18px;border-radius:12px;color:#fff;font-weight:800;cursor:pointer}
        .restart-btn{background:linear-gradient(135deg,#11998e,#38ef7d);border:none;padding:10px 18px;border-radius:12px;color:#fff;font-weight:800;cursor:pointer}
        @media (max-width:420px){.question{font-size:1.6rem}.answer-btn{font-size:.95rem;padding:12px}.menu-stats{flex-direction:column;align-items:center}.game-modes{grid-template-columns:1fr}}
        @keyframes pop{0%{transform:scale(.9)}50%{transform:scale(1.08)}100%{transform:scale(1)}}
        @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-6px)}75%{transform:translateX(6px)}100%{transform:translateX(0)}}
    </style>
</head>
<body>
    <div class="container">
        <div id="menuScreen" class="menu-screen">
            <div class="header"><h1>üßÆ MATEMATIK O'YIN</h1></div>
            <div class="menu-stats">
                <div class="stat-card"><div class="stat-icon">‚≠ê</div><div><div class="stat-num" id="currentScore">0</div><div class="stat-label">Ball</div></div></div>
                <div class="stat-card"><div class="stat-icon">üî•</div><div><div class="stat-num" id="currentStreak">0</div><div class="stat-label">Combo</div></div></div>
            </div>
            <div class="game-modes">
                <button class="mode-btn standard" onclick="startGame('standard')"><div class="mode-icon">üéØ</div><div>STANDART</div><div class="mode-subtitle">Osondan qiyingacha<br><small style="opacity:.88">Ideal o'quvchilar uchun</small></div><div class="multiplier-badge">1x Ball</div></button>
                <button class="mode-btn premium" onclick="startGame('premium')"><div class="mode-icon">üíé</div><div>PREMIUM</div><div class="mode-subtitle">O'rtadan qiyingacha<br><small style="opacity:.88">‚≠ê 40% ko'proq ball</small></div><div class="multiplier-badge">1.6x Ball</div></button>
            </div>
            <div style="text-align:center;opacity:.95">@vIBEX2BOT</div>
        </div>

        <div id="gameScreen" class="game-screen">
            <div id="timer" class="timer">60</div>
            <div class="game-stats">
                <div class="item"><div class="value">‚≠ê <span id="gameScore">0</span></div><div class="label">Ball</div></div>
                <div class="item"><div class="value">üî• <span id="streak">0</span></div><div class="label">Combo</div></div>
                <div class="item"><div class="value">‚úÖ <span id="correct">0</span></div><div class="label">To'g'ri</div></div>
            </div>
            <div class="question-card"><div class="question" id="question">5 + 3 = ?</div><div class="answers" id="answers"></div></div>
        </div>

        <div id="resultScreen" class="result-screen">
            <div class="result-card"><h3>üéâ O'yin Tugadi!</h3><div class="result-score" id="finalScore">0</div>
                <div class="result-details">
                    <div class="result-detail-item"><div class="icon">‚úÖ</div><div class="value" id="finalCorrect">0</div><div class="label">To'g'ri</div></div>
                    <div class="result-detail-item"><div class="icon">‚ùå</div><div class="value" id="finalWrong">0</div><div class="label">Noto'g'ri</div></div>
                    <div class="result-detail-item" style="min-width:30%"><div class="icon">üéØ</div><div class="value" id="finalAccuracy">0%</div><div class="label">Aniqlik</div><div class="accuracy-bar" style="margin-top:8px"><div class="fill" id="accuracyFill"></div></div></div>
                </div>
            </div>
            <div class="controls"><button class="restart-btn" onclick="restartGame()">üîÅ Qayta o'ynash</button><button class="back-btn" onclick="backToMenu()">üè† Menyu</button></div>
        </div>

        <div class="score-burst" id="scoreBurst">+0</div>
    </div>

    <script>
        let tg = window.Telegram?.WebApp; if (tg) { tg.ready(); tg.expand(); } else { console.warn('Telegram Web App not available - running in browser mode'); tg = { sendData(data){ console.log('sendData',data); alert('Natija yuborildi: '+JSON.parse(data).score+' ball'); }, themeParams:{} }; }

        let gameState = { score:0, correct:0, wrong:0, streak:0, timeLeft:60, currentAnswer:0, mode:'standard', timer:null, multiplier:1 };
        let questionQueue = []; // holds upcoming questions when not in hard-mode
        let hardMode = false; // active when streak >= 6

        function getDifficultyRanges(){
            return {
                easy: {min:1,max:10,ops:['+','-']},
                medium: {min:10,max:40,ops:['+','-','√ó']},
                hard: {min:20,max:80,ops:['+','-','√ó','√∑']},
                advanced: {min:20,max:150,ops:['+','-','√ó','√∑','combo']}
            }
        }

        function generateQuestionByLevel(level){
            const ranges = getDifficultyRanges();
            const diff = ranges[level] || ranges.easy;
            if(level === 'advanced'){
                // more steps: produce a 2-op expression like (a√ób)+c or a+(b√∑c)
                const a = rand(diff.min, diff.max);
                const b = rand(2, Math.min(12, Math.floor(diff.max/2)));
                const c = rand(1, Math.min(20, Math.floor(diff.max/4)));
                const pattern = Math.random() < 0.5 ? `${a} √ó ${b} + ${c}` : `${a} + ${b} √ó ${c}`;
                const answer = pattern.includes('√ó') && pattern.includes('+') ? eval(pattern.replace('√ó','*')) : eval(pattern.replace('√ó','*'));
                return {question: pattern + ' = ?', answer: Number.isInteger(answer) ? answer : parseFloat(answer.toFixed(2)) };
            }
            let num1 = rand(diff.min, diff.max);
            let num2 = rand(diff.min, diff.max);
            let op = diff.ops[Math.floor(Math.random()*diff.ops.length)];
            if(op === '-' && num2 > num1) [num1,num2] = [num2,num1];
            if(op === '√∑'){
                num2 = Math.max(1, num2);
                const factor = rand(1,6);
                num1 = num2 * factor;
            }
            let answer;
            switch(op){case '+': answer = num1 + num2; break; case '-': answer = num1 - num2; break; case '√ó': answer = num1 * num2; break; case '√∑': answer = num1 / num2; break}
            return {question: `${num1} ${op} ${num2} = ?`, answer: Number.isInteger(answer) ? answer : parseFloat(answer.toFixed(2)) };
        }

        function rand(a,b){ return Math.floor(Math.random()*(b-a+1))+a }

        function generateAnswerOptions(correct){
            const choices = [correct];
            const isFloat = !Number.isInteger(correct);
            while(choices.length < 4){
                let delta = rand(1, Math.max(3, Math.round(Math.abs(correct)*0.15))); // up to ~15% variation
                // sometimes mirror digits or small swap
                let variant;
                if(Math.random() < 0.25 && Number.isInteger(correct)){
                    // digit swap
                    const s = String(Math.abs(correct));
                    if(s.length > 1){
                        const i = rand(0,s.length-2);
                        const arr = s.split(''); [arr[i], arr[i+1]] = [arr[i+1], arr[i]]; variant = parseInt(arr.join('')) * (correct<0?-1:1);
                    }
                }
                if(variant === undefined){
                    variant = (Math.random() < 0.5) ? correct + delta : correct - delta;
                    if(isFloat) variant = parseFloat(variant.toFixed(2));
                }
                if(variant !== correct && !choices.includes(variant) && variant > -1000) choices.push(variant);
            }
            return choices.sort(()=>Math.random()-0.5);
        }

        function buildShuffledBatch(){
            // 2 easy, 2 medium, 2 hard, shuffled
            const arr = [];
            for(let i=0;i<2;i++) arr.push('easy');
            for(let i=0;i<2;i++) arr.push('medium');
            for(let i=0;i<2;i++) arr.push('hard');
            // shuffle
            for(let i=arr.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] }
            // map to question objects
            questionQueue = arr.map(level=>generateQuestionByLevel(level));
        }

        function getNextQuestion(){
            // If hardMode (combo >=6) then return advanced questions continuously
            if(hardMode) return generateQuestionByLevel('advanced');
            if(questionQueue.length === 0) buildShuffledBatch();
            return questionQueue.shift();
        }

        function showQuestion(){
            const q = getNextQuestion();
            gameState.currentAnswer = q.answer;
            document.getElementById('question').textContent = q.question;
            const answers = generateAnswerOptions(q.answer);
            const answersDiv = document.getElementById('answers'); answersDiv.innerHTML = '';
            answers.forEach(ans=>{ const btn = document.createElement('button'); btn.className='answer-btn'; btn.textContent = ans; btn.onclick = ()=>checkAnswer(ans,btn); answersDiv.appendChild(btn); });
        }

        function checkAnswer(selected, btn){
            const buttons = document.querySelectorAll('.answer-btn'); buttons.forEach(b=>b.disabled=true);
            const sel = (typeof selected === 'string')?Number(selected):selected;
            if(Math.abs(sel - gameState.currentAnswer) < 0.0001){
                btn.classList.add('correct'); gameState.correct++; gameState.streak++;
                // update hardMode state
                if(gameState.streak >= 6 && !hardMode){ hardMode = true; }
                let points = 10 * gameState.multiplier;
                if(gameState.streak>=3) points += 3 * gameState.multiplier;
                if(gameState.streak>=5) points += 7 * gameState.multiplier;
                if(gameState.timeLeft>50) points += 5 * gameState.multiplier;
                gameState.score += Math.round(points);
                showScoreBurst('+'+Math.round(points));
                if(gameState.streak>0 && gameState.streak%3===0){ gameState.timeLeft += 3; showTimeBonus(3) }
                if(gameState.streak>=5) showCombo(gameState.streak);
                updateStats();
                setTimeout(()=>{ btn.classList.remove('correct'); showQuestion(); },500);
            } else {
                btn.classList.add('wrong'); gameState.wrong++; // reset streak
                gameState.streak = 0; hardMode = false; // revert to normal batch when combo breaks
                // regenerate next batch so it's fresh
                buildShuffledBatch();
                gameState.score = Math.max(0, gameState.score - Math.round(5*gameState.multiplier)); showScoreBurst('-'+Math.round(5*gameState.multiplier)); updateStats();
                buttons.forEach(b=>{ if(Number(b.textContent) === gameState.currentAnswer) b.classList.add('correct') });
                setTimeout(()=>{ btn.classList.remove('wrong'); buttons.forEach(b=>b.classList.remove('correct')); showQuestion(); },900);
            }
        }

        function showCombo(streak){ const el = document.createElement('div'); el.style.position='fixed'; el.style.left='50%'; el.style.top='48%'; el.style.transform='translate(-50%,-50%)'; el.style.background='linear-gradient(135deg,#ffb347,#ffcc33)'; el.style.padding='12px 18px'; el.style.borderRadius='12px'; el.style.fontWeight='900'; el.style.zIndex=2000; el.textContent = `üî• ${streak}x COMBO!`; document.body.appendChild(el); setTimeout(()=>el.remove(),700); }
        function showTimeBonus(s){ const el = document.createElement('div'); el.style.position='fixed'; el.style.left='50%'; el.style.top='18%'; el.style.transform='translate(-50%,0)'; el.style.background='rgba(74,222,128,0.95)'; el.style.padding='10px 14px'; el.style.borderRadius='10px'; el.style.fontWeight='800'; el.style.zIndex=2000; el.textContent = `+${s}s ‚è∞`; document.body.appendChild(el); setTimeout(()=>el.remove(),900); }
        function showScoreBurst(text){ const el = document.getElementById('scoreBurst'); el.textContent = text; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),700); }
        function updateStats(){ document.getElementById('gameScore').textContent = Math.round(gameState.score); document.getElementById('streak').textContent = gameState.streak; document.getElementById('correct').textContent = gameState.correct; document.getElementById('currentStreak').textContent = gameState.streak; }

        function startTimer(){ const timerEl = document.getElementById('timer'); clearInterval(gameState.timer); gameState.timer = setInterval(()=>{ gameState.timeLeft--; timerEl.textContent = gameState.timeLeft; if(gameState.timeLeft<=5){ timerEl.classList.add('critical'); timerEl.classList.remove('warning') } else if(gameState.timeLeft<=15){ timerEl.classList.add('warning'); timerEl.classList.remove('critical') } else { timerEl.classList.remove('warning','critical') } if(gameState.timeLeft<=0) endGame(); },1000); }

        function startGame(mode){ gameState = {score:0,correct:0,wrong:0,streak:0,timeLeft:60,mode:mode,timer:null,multiplier: mode==='premium'?1.6:1}; hardMode = false; buildShuffledBatch(); document.getElementById('menuScreen').style.display='none'; document.getElementById('resultScreen').style.display='none'; document.getElementById('gameScreen').style.display='block'; updateStats(); showQuestion(); startTimer(); }

        function endGame(){ clearInterval(gameState.timer); document.getElementById('gameScreen').style.display='none'; document.getElementById('resultScreen').style.display='block'; document.getElementById('finalScore').textContent = Math.round(gameState.score); document.getElementById('finalCorrect').textContent = gameState.correct; document.getElementById('finalWrong').textContent = gameState.wrong; const total = gameState.correct + gameState.wrong; const accuracy = total>0? (gameState.correct/total*100).toFixed(1):0; document.getElementById('finalAccuracy').textContent = accuracy + '%'; document.getElementById('accuracyFill').style.width = accuracy + '%'; const urlParams = new URLSearchParams(window.location.search); const gameId = urlParams.get('game'); const resultData = { score: Math.round(gameState.score), correct: gameState.correct, wrong: gameState.wrong, mode: gameState.mode }; if(gameId) resultData.game_id = gameId; try{ tg.sendData(JSON.stringify(resultData)); }catch(e){ console.warn('sendData failed',e) } }

        function backToMenu(){ document.getElementById('resultScreen').style.display='none'; document.getElementById('menuScreen').style.display='block'; document.getElementById('currentScore').textContent = Math.round(gameState.score); }
        function restartGame(){ startGame(gameState.mode || 'standard'); }

        if(tg && tg.themeParams){ try{ const p = tg.themeParams; if(p.bg_color) document.body.style.background = `linear-gradient(135deg, ${p.bg_color}, ${p.secondary_bg_color||'#764ba2'})`; }catch(e){} }
    </script>
</body>
</html>
